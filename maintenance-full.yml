---

- hosts: all
  become: true
  gather_facts: true
  serial: "{{ SERIAL_COUNT | default('100%') }}"

  roles:
    - { role: maintenance,
        maintenance: {
          upgrade_type: "full",
          allow_reboot: false
        }
      }


- hosts: all
  become: true
  serial: "{{ SERIAL_COUNT | default('100%') }}"

  tasks:

    - block:
        - stat: path=/var/run/reboot-required
          register: reboot_required
          check_mode: no

        - name: Restart Server
          command: shutdown -r +1 "Reboot triggered by Ansible after system updates"
          async: 0
          poll: 0
          ignore_errors: true
          when: reboot_required.stat.exists

        - name: Wait for Server to come back
          local_action:
            wait_for
            host={{ ansible_ssh_host | default(inventory_hostname) }}
            port=22
            search_regex=OpenSSH
            state=started
            delay=20
            timeout=300
          when: reboot_required.stat.exists
          become: false
      when: allow_reboot is not defined or (allow_reboot is defined and allow_reboot == true)
