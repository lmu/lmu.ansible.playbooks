---

- hosts: solrs
  sudo: true

  vars:
    java:
      version: 7
      type: OpenJDK
      jdk: false


  roles:
    - base-preseed
    - java
    - { role: maintenance,
        maintenance: {
          upgrade_type: "full",
          allow_reboot: false
        }
      }
    - supervisor



- hosts: solr-masters-production
  sudo: true


  handlers:
    - include: roles/supervisor/handlers/main.yml

  roles:
    - { role: zc.buildout,
        buildout: {
          path: '/usr/local/',
          directory: 'solr.buildout',
          config: 'production-master.cfg',
          requires_secrets: true,
          secrets: 'templates/secrets.cfg.j2',
          login: 'admin',
          password: 'admin',
          src: {
            src: 'https://github.com/loechel/solr.buildout.git',
            type: 'git',
            rev: 'master'
          }
        }
      }
  tasks:

    - name: "check if 'solr-instance' is present"
      supervisorctl:
        name="solr-instance"
        state=present

    - name: "Restart Supervisor"
      service:
        name=supervisor
        state=restarted
        sleep=5

- hosts: solr-slaves-production
  sudo: true

  handlers:
    - include: roles/supervisor/handlers/main.yml

  roles:
    - { role: zc.buildout,
        buildout: {
          path: '/usr/local/',
          directory: 'solr.buildout',
          config: 'production-slave.cfg',
          requires_secrets: true,
          secrets: 'templates/secrets.cfg.j2',
          login: 'admin',
          password: 'admin',
          src: {
            src: 'https://github.com/loechel/solr.buildout.git',
            type: 'git',
            rev: 'master'
          }
        }
      }
  tasks:

    - name: "check if 'solr-instance' is present"
      supervisorctl:
        name="solr-instance"
        state=present

    - name: "Restart Supervisor"
      service:
        name=supervisor
        state=restarted
        sleep=5

- hosts: solr-masters-staging
  sudo: true


  handlers:
    - include: roles/supervisor/handlers/main.yml

  roles:
    - { role: zc.buildout,
        buildout: {
          path: '/usr/local/',
          directory: 'solr.buildout',
          config: 'staging-master.cfg',
          requires_secrets: true,
          secrets: 'templates/secrets.cfg.j2',
          login: 'admin',
          password: 'admin',
          src: {
            src: 'https://github.com/loechel/solr.buildout.git',
            type: 'git',
            rev: 'master'
          }
        }
      }
  tasks:

    - name: "check if 'solr-instance' is present"
      supervisorctl:
        name="solr-instance"
        state=present

    - name: "Restart Supervisor"
      service:
        name=supervisor
        state=restarted
        sleep=5

- hosts: solr-slaves-staging
  sudo: true

  handlers:
    - include: roles/supervisor/handlers/main.yml

  roles:
    - { role: zc.buildout,
        buildout: {
          path: '/usr/local/',
          directory: 'solr.buildout',
          config: 'staging-slave.cfg',
          requires_secrets: true,
          secrets: 'templates/secrets.cfg.j2',
          login: 'admin',
          password: 'admin',
          src: {
            src: 'https://github.com/loechel/solr.buildout.git',
            type: 'git',
            rev: 'master'
          }
        }
      }
  tasks:

    - name: "check if 'solr-instance' is present"
      supervisorctl:
        name="solr-instance"
        state=present

    - name: "Restart Supervisor"
      service:
        name=supervisor
        state=restarted
        sleep=5