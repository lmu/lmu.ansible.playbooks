<VirtualHost  141.84.149.205:80 [2001:4ca0:4f04:f096::141.84.149.205]:80>
	
	# Kontaktadresse des für den Server zuständigen, sind wohl immer wir
	ServerAdmin edv.security@verwaltung.uni-muenchen.de
	
	# Wenn es statische Inhalte gibt, kommt hier das Verzeichnis rein, wo die liegen
	# wenn es keine gibt, ist es /var/www/html
	DocumentRoot /var/www/html

	# Der vollständige Servername (FQDN)
	ServerName www.intranet.verwaltung.uni-muenchen.de
	# Sonstige Namen des Servers, mehrere können konfiguriert werden
	# im Moment noch keine bekannt

	
	# Ort der Fehlerlogs, <kurzname> ist ein kurzer Name für den vhost (z.B. der, der auch im Firewall-Regelsatz für diese IP-Adresse verwendet wird)

	ErrorLog /var/www/logs/zuv_intranet/error_log
	# Ort der Access-Logs, das Format kann auch je nach Anforderung variiert werden
	CustomLog /var/www/logs/zuv_intranet/access_log "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\" Server: %{Host}i" 

	# Optional: Pflicht-Redirect auf die SSL-Variante des vhosts
	Redirect / https://www.intranet.verwaltung.uni-muenchen.de/

</VirtualHost>

<VirtualHost  141.84.149.205:443 [2001:4ca0:4f04:f096::141.84.149.205]:443>
	# Das gleiche wie oben
	ServerAdmin edv.security@verwaltung.uni-muenchen.de
	ServerName www.intranet.verwaltung.uni-muenchen.de
        DocumentRoot "/var/www/html"

        <Location />
                Order Deny,Allow
                Deny from All
                Allow from 172.23.0.0/16 141.84.149.18 141.84.149.19 127.0.0.1  141.84.149.192/26
        </Location>

        <LocationMatch "^/(?!(css|layout|funktionen|(funktionen/logout)|(funktionen/faq_login)|(funktionen/loginscreen_text)|benutzerkennung|_assets|assets|system|sp))"> # Der Regexp bedeutet: ^: Anfang, /: genau das, (? : non-capturing group, die mit "!" negiert wird
                AuthType shibboleth
                Require shibboleth
                ShibUseHeaders On
                ShibRequireSession On
        </LocationMatch>

	<Location /sp>
		# Diese Regel unterbindet, dass mod_security den REquest-Body auswertet
		# Das hat folgende Gründe
		# Der Body mit der SAML-Assertion ist in der Regel verschlüsselt, das bedeutet, dass
		# * mod_security ohnehin nichts erkennen kann
		# * weil verschlüsseltes Zeug wie zufälliges Zeug aussieht, sinnloserweise immer wieder Regeln matchen
		# * es dauert 50 Sekunden, bis mod_security mit dem Untersuchen dieser Daten fertig ist...
		SecRequestBodyAccess Off
	</Location>

	# Die Logddaten für den SSL-Teil sollten vom nicht-SSL-Teil getrennt sein, i.d.R. einfach ssl_ vor den namen setzen
        ErrorLog /var/www/logs/zuv_intranet/ssl_error_log
        CustomLog /var/www/logs/zuv_intranet/ssl_access_log "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\" Server: %{Host}i" 

	# Schaltet die SSL-Maschinerie an
	SSLEngine on

	# Legt die Unterstützten Protokollversionen fest, hier ist alles ab TLS 1.0 und höher zugelassen, also kein SSLv2 und SSLv3
	SSLProtocol all -SSLv2 -SSLv3

	# Die Verschlüsselungsalgorithmen, mit openssl ciphers 'HIGH:!MEDIUM:!aNULL:!MD5:-RSA' kann man die sich anzeigen lassen
	SSLCipherSuite HIGH:!MEDIUM:!aNULL:!MD5:-RSA

	# Datei mit dem Serverzertifikat
	SSLCertificateFile /shared/pki/certs/www.intranet.verwaltung.uni-muenchen.de.pem
	# Datei mit dem Key dazu
	SSLCertificateKeyFile /shared/pki/keys/www.intranet.verwaltung.uni-muenchen.de_key.pem

	# Die Certificate Chain, also alle Zertifikate bis zur Wurzel-CA
	SSLCertificateChainFile /shared/pki/certs/dfn-chain.crt


	# Das sind ein paar abgeschriebene Sachen, wird schon passen
	<Files ~ "\.(cgi|shtml|phtml|php3?)$">
	    SSLOptions +StdEnvVars
	</Files>
	<Directory "/var/www/cgi-bin">
	    SSLOptions +StdEnvVars
	</Directory>

	# Wird wohl für den Internet Explorer gebraucht
	SetEnvIf User-Agent ".*MSIE.*" \
		 nokeepalive ssl-unclean-shutdown \
		 downgrade-1.0 force-response-1.0

</VirtualHost>

