<VirtualHost webproxy_www.intranet.verwaltung.uni-muenchen.de:80>

    # Kontaktadresse des für den Server zuständigen:
    ServerAdmin Alexander.Loechel@verwaltung.uni-muenchen.de

    # Wenn es statische Inhalte gibt,
    # Hier das Verzeichnis angeben wo dieses liegt,
    # wenn es keine gibt: default: /var/www/html
    DocumentRoot /var/www/html

    # Vollständiger ServerName (FQDN)
    #ServerName www.intranet.verwaltung.uni-muenchen.de
    ServerName webproxy_www.intranet.verwaltung.uni-muenchen.de
    # Sonsitige Namen des Server, mehrere können konfiguriert werden:
    # ServerAlias

    # 
    UseCanonicalName on

    # Ort der Log-Files, <kurzname> ist ein kurzer Name für den vhost (z.B. der, der auch im Firewall-Regelsatz für diese IP-Adresse verwendet wird)
    ErrorLog "|/usr/sbin/rotatelogs2 /var/log/apache/zuv_intranet/error_log.%Y-%m-%d-%H_%M_%S 5M"
    # Ort der Access-Logs, das Format kann auch je nach Anforderung variiert werden
    CustomLog "|/usr/sbin/rotatelogs2 /var/log/apache/zuv_intranet/access_log.%Y-%m-%d-%H_%M_%S 5M"
    TransferLog "|/usr/sbin/rotatelogs2 /var/log/apache/zuv_intranet/transfer.log.%Y-%m-%d-%H_%M_%S 5M"
    RewriteLog "|/usr/sbin/rotatelogs2 /var/log/apache2/zuv_intarnet/rewrite.log.%Y-%m-%d-%H_%M_%S 5M"

    # Welches Log-Detaillevel wollen wir
    LogLevel info

    # Setzt / Verändert Core Parameter des Apache httpd, wieviele Request Header Informationen er zulässt.
    # Hohe Anzal ist wichtig wegen Shibboleth Headern
    LimitRequestBody 0
    LimitRequestFields 250
    LimitRequestFieldSize 65536
    LimitRequestLine 65536

    # Das sind ein paar abgeschriebene Sachen, wird schon passen
    <Files ~ "\.(cgi|shtml|phtml|php3?)$">
        SSLOptions +StdEnvVars
    </Files>
    <Directory "/var/www/cgi-bin">
        SSLOptions +StdEnvVars
    </Directory>

    # Proxy-Regeln für Backend
    ProxyVia On
    ProxyRequests Off
    ProxyPreserveHost On

    # prevent your web server from being used as global HTTP proxy
    <LocationMatch "^[^/]">
        Deny from all
    </LocationMatch>

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    Header set X-Frame-Options "SAMEORIGIN"
    Header set Strict-Transport-Security "max-age=15768000; includeSubDomains"
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Type-Options "nosniff"
    #Header set Content-Security-Policy-Report-Only "default-src 'self'; img-src *; style-src 'unsafe-inline'; script-src 'unsafe-inline' 'unsafe-eval'"
    Header set Content-Security-Policy "default-src 'self' cms-static.uni-muenchen.de iukintest.verwaltung.uni-muenchen.de iuksptest.verwaltung.uni-muenchen.de; \
script-src 'self' 'unsafe-inline' 'unsafe-eval' cms-static.uni-muenchen.de iukintest.verwaltung.uni-muenchen.de iuksptest.verwaltung.uni-muenchen.de; \
style-src 'self' 'unsafe-inline' cms-static.uni-muenchen.de *.verwaltung.uni-muenchen.de; \
img-src 'self' 'unsafe-inline' cms-static.uni-muenchen.de www.uni-muenchen.de *.verwaltung.uni-muenchen.de; \
font-src 'self' 'unsafe-inline' cms-static.uni-muenchen.de *.verwaltung.uni-muenchen.de; \
object-src 'self' cms-static.uni-muenchen.de *.verwaltung.uni-muenchen.de;"
    RequestHeader set X-Forwarded-For "iukintest.verwaltung.uni-muenchen.de:443"

    <LocationMatch "\.(ttf|otf|eot|woff|js|css|xml|json|include|jepg|png|gif|jpg|svg)$">
        Header set Access-Control-Allow-Origin "*"
    </LocationMatch>

    RewriteEngine on
    RewriteLogLevel info

    RewriteRule ^/functions/extras.css$  https://iukintest.verwaltung.uni-muenchen.de/++resource++lmu.theme.intranet.css/extras.css [R=301,L]
    RewriteRule ^/functions/extras.js$  https://iukintest.verwaltung.uni-muenchen.de/++resource++lmu.theme.intranet.js/extras.js [R=301,L]

    # Blacklist Fiona Pfade so das Plone auf Root Path / lauscht
    RewriteRule ^/index.html - [L,NC]

    include fiona_intranet_backlist.include

    # RewriteRule ^/_assets - [L,NC]
    # RewriteRule ^/_sync - [L,NC]
    # RewriteRule ^/servlet - [L,NC]
    # RewriteRule ^/servlets - [L,NC]
    # RewriteRule ^/resources - [L,NC]
    # RewriteRule ^/footer - [L,NC]
    # RewriteRule ^/system - [L,NC]
    # RewriteRule ^/aktuelles - [L,NC]
    # RewriteRule ^/leitbild - [L,NC]
    # RewriteRule ^/leitbild-startseite - [L,NC]
    # RewriteRule ^/funktionen - [L,NC]
    # RewriteRule ^/besser-werden - [L,NC]
    # RewriteRule ^/einrichtungen - [L,NC]
    # RewriteRule ^/meine-angebote - [L,NC]
    # RewriteRule ^/personen - [L,NC]
    # RewriteRule ^/services - [L,NC]
    # RewriteRule ^/weiterbildung - [L,NC]
    # RewriteRule ^/wir-haben-verbessert - [L,NC]
    # RewriteRule ^/wissen - [L,NC]

    RewriteRule ^/(.*)$ http://127.0.0.1:6081/VirtualHostBase/https/www.intranet.verwaltung.uni-muenchen.de:443/intranet/VirtualHostRoot/$1 [P,L]

    ProxyPass /system/ http://cms-test-pm3.verwaltung.uni-muenchen.de:8080/system/
    ProxyPassReverse /system/ http://cms-test-pm3.verwaltung.uni-muenchen.de:8080/system/

    ProxyPass /servlet/ http://cms-test-pm3.verwaltung.uni-muenchen.de:8080/servlet/
    ProxyPassReverse /servlet/ http://cms-test-pm3.verwaltung.uni-muenchen.de:8080/servlet/

    ProxyPass / http://cms-test-pm3.verwaltung.uni-muenchen.de:8080/
    ProxyPassReverse / http://cms-test-pm3.verwaltung.uni-muenchen.de:8080/

</VirtualHost>

<VirtualHost www.intranet.verwaltung.uni-muenchen.de:443>

    # Kontaktadresse des für den Server zuständigen:
    ServerAdmin it.security@verwaltung.uni-muenchen.de
    ServerName www.intranet.verwaltung.uni-muenchen.de

    # 
    UseCanonicalName on

    # Wenn es statische Inhalte gibt,
    # Hier das Verzeichnis angeben wo dieses liegt,
    # wenn es keine gibt: default: /var/www/html
    DocumentRoot /var/www/html

    # Ort der Log-Files, <kurzname> ist ein kurzer Name für den vhost (z.B. der, der auch im Firewall-Regelsatz für diese IP-Adresse verwendet wird)
    ErrorLog "|/usr/sbin/rotatelogs2 /var/log/apache/zuv_intranet/ssl_error_log.%Y-%m-%d-%H_%M_%S 5M"
    # Ort der Access-Logs, das Format kann auch je nach Anforderung variiert werden
    CustomLog "|/usr/sbin/rotatelogs2 /var/log/apache/zuv_intranet/ssl_access_log.%Y-%m-%d-%H_%M_%S 5M"
    TransferLog "|/usr/sbin/rotatelogs2 /var/log/apache/zuv_intranet/ssl_transfer.log.%Y-%m-%d-%H_%M_%S 5M"
    RewriteLog "|/usr/sbin/rotatelogs2 /var/log/apache2/zuv_intarnet/ssl_rewrite.log.%Y-%m-%d-%H_%M_%S 5M"

    # Welches Log-Detaillevel wollen wir
    LogLevel info

    # Setzt / Verändert Core Parameter des apache, wieviele Request Header Informationen er zulässt.
    LimitRequestBody 0
    LimitRequestFields 250
    LimitRequestFieldSize 65536
    LimitRequestLine 65536

    # Schaltet die SSL-Maschinerie an
    SSLEngine on

    # Legt die Unterstützten Protokollversionen fest, hier ist alles ab TLS 1.0 und höher zugelassen, also kein SSLv2 und SSLv3
    SSLProtocol all -SSLv2 -SSLv3

    # Die Verschlüsselungsalgorithmen, mit openssl ciphers 'HIGH:!MEDIUM:!aNULL:!MD5:-RSA' kann man die sich anzeigen lassen
    SSLCipherSuite HIGH:!MEDIUM:!aNULL:!MD5:-RSA

    # Datei mit dem Serverzertifikat
    SSLCertificateFile /shared/pki/certs/www.intranet.verwaltung.uni-muenchen.de.pem
    # Datei mit dem Key dazu
    SSLCertificateKeyFile /shared/pki/keys/www.intranet.verwaltung.uni-muenchen.de_key.pem

    # Die Certificate Chain, also alle Zertifikate bis zur Wurzel-CA
    SSLCertificateChainFile /shared/pki/certs/dfn-chain.crt

    # Das sind ein paar abgeschriebene Sachen, wird schon passen
    <Files ~ "\.(cgi|shtml|phtml|php3?)$">
        SSLOptions +StdEnvVars
    </Files>
    <Directory "/var/www/cgi-bin">
        SSLOptions +StdEnvVars
    </Directory>
    # Wird wohl für den Internet Explorer gebraucht
    SetEnvIf User-Agent ".*MSIE.*" \
         nokeepalive ssl-unclean-shutdown \
         downgrade-1.0 force-response-1.0

    # Proxy-Regeln für Backend
    ProxyVia On
    ProxyRequests Off
    ProxyPreserveHost On

    # prevent your web server from being used as global HTTP proxy
    <LocationMatch "^[^/]">
        Deny from all
    </LocationMatch>

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

## Überarbeiten
    <LocationMatch "^(?!/(css|layout|funktionen|(funktionen/logout)|(funktionen/faq_login)|(funktionen/loginscreen_text)|benutzerkennung|_assets|assets|system|_sync|(functions/portal_css)|(functions/portal_javascripts))/.*|(.*)/(RSS|rss.xml|atom.xml))/.*$">
#   <LocationMatch "^(?!/(css|layout|funktionen|(funktionen/logout)|(funktionen/faq_login)|(funktionen/loginscreen_text)|benutzerkennung|_assets|assets|system|(functions/portal_css)|(functions/portal_javascripts)))/.*$">
        # Alle Regulären Seiten sollen via Shibboleth authentifiziert werden, dies ist eine auf invertierter Blacklist gezogener Zugriffsbeschränkter Bereich.
        AuthType shibboleth
        ShibUseHeaders On
        ShibRequireSession On
#       ShibExpireRedirects On
        # Definiere finale Gruppe
        # Require groupMembershiop cn=zuv-intranet-users,ou=,o=uni-muenchen,c=de
        Require groupMembership cn=test,ou=Manuell,ou=LMU-Portal,ou=anwendungen,o=uni-muenchen,c=de
    </LocationMatch>

    <LocationMatch "^(.*)\/(RSS|rss.xml|atom.xml)$" >
        # RSS / Atom Feed sollen via Basic-Authentifizierung erreichbar sein, damit alle Clients diese benutzten können.
        AuthType Basic
        AuthBasicProvider ldap
        AuthLDAPURL ldap://ldap-lb.verwaltung.uni-muenchen.de/ou=benutzer,o=uni-muenchen,c=de
        AuthBasicAuthoritative Off
        AuthLDAPRemoteUserAttribute cn
        RequestHeader set REMOTE_USER %{REMOTE_USER}
        AuthName "ZUV-Intranet"
        # Definiere finale Gruppe
        # Require groupMembershiop cn=zuv-intranet-users,ou=,o=uni-muenchen,c=de
        Require ldap-group cn=test,ou=Manuell,ou=LMU-Portal,ou=anwendungen,o=uni-muenchen,c=de
    </LocationMatch>

    # Setzte Spezielle Header:
    # Securtity Header (HSTS, Content-Security-Policy, X-Frame-Options, X-XSS-Protection, X-Content-Type-Options, Access-Control-Allow-Origin) usw. werdem vom WebProxy gesetzt
    # Setzte für welche Domain der Forward / ProxyPass ist.
    RequestHeader set X-Forwarded-For "www.intranet.verwaltung.uni-muenchen.de:443"

    ProxyPass /sp !
    ProxyPass /Shibboleth.sso !
    ProxyPass /shibboleth-sp !

    ProxyPass / http://webproxy_www.internet.verwaltun.uni-meunchen.de:80/
    ProxyPassReverse / http://webproxy_www.internet.verwaltun.uni-meunchen.de:80/

</VirtualHost>
