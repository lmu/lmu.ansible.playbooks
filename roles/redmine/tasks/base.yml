---

- name: "Ensure Ruby is installed"
  apt:
    pkg={{ item }}
    state=present
    update_cache=yes
    install_recommends=yes
  with_items:
    - ruby2.0
    - ruby2.0-dev
    - ruby-dev
    - build-essential
    - git
    - subversion
  when: ansible_os_family == "Debian"


- name: "Ensure Ruby dependencies are installed"
  apt:
    pkg={{ item }}
    state=build-dep
    update_cache=no
    install_recommends=yes
  with_items:
    - ruby-rmagick
    - ruby-bundler
  when: ansible_os_family == "Debian"

- name: "Ensure Group redmine exists"
  group:
    name="redmine"
    state=present

- name: "Ensure User redmine exists"
  user:
    name="redmine"
    group="redmine"
    force=true
    uid=980
    state=present

- name: "Ensure Base directories exists"
  file:
    path="{{ item }}"
    state=directory
    owner=redmine
    group=redmine
    mode="u=rwx,g=rwx,o=rx"
  with_items:
    - "{{ redmine.app_base_path }}"
    - "{{ redmine.data_base_path }}"
    - "{{ redmine.log_base_path }}"
    #- "{{ redmine.run_base_path }}"

- name: "Ensure local download directories exists"
  file:
    path="{{ item }}"
    state=directory
    owner=redmine
    group=redmine
    mode="u=rwx,g=rwx,o=rwx"
  with_items:
    - "/tmp/redmine-plugins"
    - "/tmp/redmine-themes"

- name: "Ensure local download directories exists"
  file:
    path="{{ item }}"
    state=directory
    mode="u=rwx,g=rwx,o=rwx"
  delegate_to: localhost
  become: false
  with_items:
    - "/tmp/redmine-plugins-download"
    - "/tmp/redmine-plugins"
    - "/tmp/redmine-themes-download"
    - "/tmp/redmine-themes"

- name: "Install bundler for Ruby 2.0"
  command: gem2.0 install bundler
