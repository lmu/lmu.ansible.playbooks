---

- name: "Update all Packages (Mode: {{ maintenance.upgrade_type }})"
  apt: upgrade={{ maintenance.upgrade_type }} update_cache=yes
  when: ansible_os_family == "Debian"
  notify: 
  - "Restart Server"
  - "Inform that Server needs restart and is disallowed"
  - "Wait for Server to come back"

- stat: path=/var/run/reboot-required
  register: reboot_required

- name: "Check if anything needs autoremoving"
  shell: apt-get autoremove -y --dry-run
  sudo: True
  register: check_autoremove
  changed_when: "' 0 zu entfernen' not in check_autoremove.stdout"
  failed_when: "check_autoremove.rc != 0"
  always_run: True

- name: "Autoremove unused Packages"
  command: apt-get autoremove -y
  when: "check_autoremove.rc == 0 and ' 0 zu entfernen' not in check_autoremove.stdout"
  register: autoremove
