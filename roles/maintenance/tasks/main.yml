---

- name: "Update all Packages (Mode: {{ maintenance.upgrade_type }})"
  apt: upgrade={{ maintenance.upgrade_type }} update_cache=yes
  when: ansible_os_family == "Debian"
  notify: 
  - "Restart Server"
  - "Wait for Server to come back"

- stat: path=/var/run/reboot-required
  register: reboot_required

- name: "Check if anything needs autoremoving"
  shell: apt-get autoremove -y --dry-run
  sudo: True
  register: check_autoremove
  changed_when: "' 0 zu entfernen' not in check_autoremove.stdout"
  failed_when: "check_autoremove.rc != 0"
  always_run: True

- name: "Autoremove unused Packages"
  command: apt-get autoremove -y
  when: "check_autoremove.rc == 0 and ' 0 zu entfernen' not in check_autoremove.stdout"
  register: autoremove

- name: "Inform that Server needs restart and is disallowed"
  debug: 
    msg="Server {{ inventory_hostname }} needs restart, please perform / start this manually."
  when: reboot_required.stat.exists and not maintenance.allow_reboot
  changed_when: reboot_required.stat.exists and not maintenance.allow_reboot

- name: "Restart Server if allowed"
  command: shutdown -r now "Reboot triggered by Ansible after system updates"
  async: 0
  poll: 0
  ignore_errors: true
  when: reboot_required.stat.exists and ansible_os_family == "Debian" and maintenance.allow_reboot 
  notify: 
  - "Wait for Server to come back"
