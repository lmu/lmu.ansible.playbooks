---

- name: "Update all Packages (Mode: {{ maintenance.upgrade_type }})"
  apt: upgrade={{ maintenance.upgrade_type }} update_cache=yes
  when: ansible_os_family == "Debian"
  notify:
  - "Restart Server"
  - "Wait for Server to come back"

- stat: path=/var/run/reboot-required
  register: reboot_required
  always_run: True

- name: "Check if anything needs autoremoving"
  shell: apt-get autoremove -y --dry-run
  become: True
  register: check_autoremove
  changed_when: "' 0 to remove' not in check_autoremove.stdout"
  failed_when: "check_autoremove.rc != 0"
  always_run: True
  environment:
    LC_ALL: C
    LANG: en

- name: "Autoremove unused Packages"
  command: apt-get autoremove -y
  when: "check_autoremove.rc == 0 and ' 0 to remove' not in check_autoremove.stdout"
  register: autoremove

- name: "Inform that Server needs restart and is disallowed"
  debug:
    msg="Server {{ inventory_hostname }} needs restart, please perform / start this manually."
  when: reboot_required.stat.exists and not maintenance.allow_reboot
  changed_when: reboot_required.stat.exists and not maintenance.allow_reboot

- name: "Inform that Server needs restart and will be restarted"
  debug:
    msg="Server {{ inventory_hostname }} needs restart and will be restarted, now."
  when: reboot_required.stat.exists and maintenance.allow_reboot
  changed_when: reboot_required.stat.exists and maintenance.allow_reboot
  notify:
  - "Restart Server"
  - "Wait for Server to come back"
