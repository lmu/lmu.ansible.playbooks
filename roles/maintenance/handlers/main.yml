---

- name: "Restart Server"
  command: shutdown -r +1 "Reboot triggered by Ansible after system updates"
  async: 0
  poll: 0
  ignore_errors: true
  when: reboot_required.stat.exists and maintenance.allow_reboot

- name: "Wait for Server to come back"
  local_action:
    wait_for
    host={{ ansible_ssh_host | default(inventory_hostname) }}
    port=22
    search_regex=OpenSSH
    state=started
    delay=20
    timeout=300
  become: false
  when: reboot_required.stat.exists and maintenance.allow_reboot

- name: "Delete reboot_required file"
  file:
    path=/var/run/reboot-required
    state=absent

...
